#!/usr/bin/env bash
#
# BACstop git hook
# Runs a BACtrack breathalyzer check before commit or push.
#
# Spice levels:
#   verde  â€” informational only, always allows the action
#   hot    â€” blocks the action if BAC is below threshold
#   diablo â€” blocks AND nukes your changes if BAC is below threshold
#
# Configuration read from .bacstop (key=value):
#   threshold=0.00
#   spice=hot
#   hook=pre-push
#
# Environment variable overrides:
#   BACSTOP_THRESHOLD, BACSTOP_SPICE
#

set -uo pipefail

# â”€â”€ Find repo root â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
CONFIG="$REPO_ROOT/.bacstop"

# â”€â”€ Read config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
read_config() {
    local key="$1"
    local default="$2"
    if [ -f "$CONFIG" ]; then
        local val
        val="$(grep -E "^${key}=" "$CONFIG" 2>/dev/null | head -1 | cut -d'=' -f2- | tr -d '[:space:]')"
        if [ -n "$val" ]; then
            echo "$val"
            return
        fi
    fi
    echo "$default"
}

THRESHOLD="${BACSTOP_THRESHOLD:-$(read_config threshold 0.00)}"
SPICE="${BACSTOP_SPICE:-$(read_config spice hot)}"
HOOK_TYPE="$(read_config hook pre-push)"

# â”€â”€ Detect which hook we're running as â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# $0 is the hook path, e.g. .git/hooks/pre-push or .git/hooks/pre-commit
HOOK_NAME="$(basename "$0")"

# â”€â”€ Spice label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
case "$SPICE" in
    verde)  SPICE_LABEL="VERDE (informational)" ;;
    diablo) SPICE_LABEL="DIABLO (destructive)"  ;;
    *)      SPICE_LABEL="HOT (blocking)"         ;;
esac

# â”€â”€ Find bactrack command â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BACTRACK=""

if command -v bactrack &>/dev/null; then
    BACTRACK="bactrack"
elif [ -x "$REPO_ROOT/venv/bin/bactrack" ]; then
    BACTRACK="$REPO_ROOT/venv/bin/bactrack"
elif [ -x "$REPO_ROOT/.venv/bin/bactrack" ]; then
    BACTRACK="$REPO_ROOT/.venv/bin/bactrack"
else
    echo ""
    echo "  BACstop: bactrack command not found."
    echo "  Install it with: pip install -e $REPO_ROOT"
    echo ""
    exit 1
fi

# â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "  â•‘            BACstop Check             â•‘"
echo "  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
printf "  â•‘  Hook:      %-24s â•‘\n" "$HOOK_NAME"
printf "  â•‘  Spice:     %-24s â•‘\n" "$SPICE"
printf "  â•‘  Threshold: %-24s â•‘\n" "${THRESHOLD}%"
echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# â”€â”€ Run the check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$BACTRACK check --threshold "$THRESHOLD"
EXIT_CODE=$?

# â”€â”€ Handle result based on spice level â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Exit code 0 = BAC above threshold (pass)
# Exit code 1 = BAC below threshold (fail)
# Exit code 2 = device/test error

if [ $EXIT_CODE -eq 2 ]; then
    echo ""
    echo "  âŒ BACstop check failed (device error)."
    echo "  Blocked for safety."
    echo ""
    exit 1
fi

if [ $EXIT_CODE -eq 0 ]; then
    # Passed â€” allow regardless of spice level
    echo ""
    echo "  âœ… BAC verified. You're good."
    echo ""
    exit 0
fi

# â”€â”€ Below threshold â€” spice determines what happens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

case "$SPICE" in

    verde)
        echo ""
        echo "  ğŸŸ¢ BAC below threshold, but spice=verde."
        echo "  Letting it slide. Be careful out there."
        echo ""
        exit 0
        ;;

    diablo)
        echo ""
        echo "  ğŸ”¥ğŸ”¥ğŸ”¥ DIABLO MODE ğŸ”¥ğŸ”¥ğŸ”¥"
        echo ""
        echo "  BAC below threshold. Nuking your changes."
        echo ""

        if [ "$HOOK_NAME" = "pre-commit" ]; then
            # Wipe staged changes and restore working tree to HEAD
            echo "  Restoring all staged and working tree changes..."
            git restore --staged --worktree . 2>/dev/null
            # Also remove any untracked files that were staged
            git clean -fd 2>/dev/null
            echo "  ğŸ’€ All changes destroyed. Start over."
        else
            # pre-push: reset to remote tracking branch
            UPSTREAM="$(git rev-parse --abbrev-ref '@{upstream}' 2>/dev/null || true)"
            if [ -n "$UPSTREAM" ]; then
                echo "  Resetting to $UPSTREAM..."
                git reset --hard "$UPSTREAM" 2>/dev/null
                echo "  ğŸ’€ Local commits obliterated."
            else
                echo "  No upstream branch found. Dropping the last commit..."
                git reset --hard HEAD~1 2>/dev/null
                echo "  ğŸ’€ Last commit destroyed."
            fi
        fi

        echo ""
        echo "  Maybe sober up before trying again."
        echo ""
        exit 1
        ;;

    *)
        # hot (default)
        echo ""
        echo "  ğŸŒ¶ï¸  BAC too low. ${HOOK_NAME} blocked."
        echo "  Come back when you've had a drink."
        echo ""
        exit 1
        ;;
esac
